# Requirements:
# - GPG_PRIVATE_KEY: CI/CD variable containing a base64-encoded GPG private key for signing.
# - GPG_PASSPHRASE: CI/CD variable with the passphrase for the above key.
# - GPG_KEY_ID: CI/CD variable with the id of the key to use for signing.
#
# Usage: Create and push a Git tag (e.g., `v1.0.0`) to trigger the release pipeline.
---
variables:
  RUSTFLAGS: "-Zlocation-detail=none -Zfmt-debug=none -Zunstable-options -Cpanic=immediate-abort"
  RUSTARGS: "-Z build-std=std,panic_abort -Z build-std-features=optimize_for_size"
  BIN_NAME: "keychron-tray-rs"
  CARGO_PROFILE: "release"
  RUST_NIGHTLY_DATE: "2026-01-16"
  RELEASE_NOTES_TEMPLATE: ".gitlab/release_template.md"

stages:
  - build
  - release

# Cache for faster builds
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - target/
    - .cargo/
    - .rustup/

# Single build job using a matrix for all targets
.build_template: &build_template
  stage: build
  image: rust:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - set -euxo pipefail

    # 1. Install the specific nightly toolchain
    - rustup toolchain install nightly-${RUST_NIGHTLY_DATE} --profile minimal
    - rustup default nightly-${RUST_NIGHTLY_DATE}
    - rustup component add rust-src

    # 2. Target-specific setup based on $TARGET variable
    - |
      case "$TARGET" in
        x86_64-unknown-linux-gnu)
          apt-get update && apt-get install -y libudev-dev
          ;;
        x86_64-unknown-linux-musl)
          apt-get update && apt-get install -y libudev-dev musl-tools
          export RUSTFLAGS="${RUSTFLAGS} -C target-feature=+crt-static"
          ;;
        aarch64-unknown-linux-gnu)
          apt-get update && apt-get install -y libudev-dev gcc-aarch64-linux-gnu
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER="aarch64-linux-gnu-gcc"
          ;;
        aarch64-unknown-linux-musl)
          apt-get update && apt-get install -y clang libudev-dev llvm musl-dev musl-tools
          export CC_aarch64_unknown_linux_musl="clang"
          export AR_aarch64_unknown_linux_musl="llvm-ar"
          export RUSTFLAGS="${RUSTFLAGS} -C linker=clang -C link-arg=--target=aarch64-unknown-linux-musl"
          ;;
        x86_64-pc-windows-msvc)
          apt-get update && apt-get install -y gcc-mingw-w64-x86-64
          ;;
        aarch64-pc-windows-msvc)
          # No special packages needed for Windows ARM64 (MSVC toolchain is bundled)
          ;;
        *)
          echo "ERROR: Unknown target: $TARGET"
          exit 1
          ;;
      esac

    # 3. Add the target and build
    - rustup target add $TARGET
    - |
      cargo build \
        $RUSTARGS \
        --target $TARGET \
        --${CARGO_PROFILE}
  artifacts:
    name: "${CI_JOB_NAME}-${TARGET}"
    paths:
      - "target/$TARGET/${CARGO_PROFILE}/${BIN_NAME}*"
    expire_in: 1 week

# --- Build Matrix Definition ---
build:
  <<: *build_template
  parallel:
    matrix:
      - TARGET: x86_64-unknown-linux-gnu
      - TARGET: x86_64-unknown-linux-musl
      - TARGET: aarch64-unknown-linux-gnu
      - TARGET: aarch64-unknown-linux-musl
      - TARGET: x86_64-pc-windows-msvc
      - TARGET: aarch64-pc-windows-msvc

# --- Release Creation Job ---
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/cli:latest
  needs:
    - job: build
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - set -euxo pipefail

    # 1. Setup: install packages, import GPG key, create directory
    - apk add --no-cache gnupg coreutils gettext
    - echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --batch --import
    - mkdir -p dist

    # 2. Copy all binaries to the dist/ folder with descriptive names
    - cp "target/x86_64-unknown-linux-gnu/${CARGO_PROFILE}/${BIN_NAME}" "dist/${BIN_NAME}-linux-x86_64-gnu"
    - cp "target/x86_64-unknown-linux-musl/${CARGO_PROFILE}/${BIN_NAME}" "dist/${BIN_NAME}-linux-x86_64-musl"
    - cp "target/aarch64-unknown-linux-gnu/${CARGO_PROFILE}/${BIN_NAME}" "dist/${BIN_NAME}-linux-aarch64-gnu"
    - cp "target/aarch64-unknown-linux-musl/${CARGO_PROFILE}/${BIN_NAME}" "dist/${BIN_NAME}-linux-aarch64-musl"
    - cp "target/x86_64-pc-windows-msvc/${CARGO_PROFILE}/${BIN_NAME}.exe" "dist/${BIN_NAME}-windows-x86_64.exe"
    - cp "target/aarch64-pc-windows-msvc/${CARGO_PROFILE}/${BIN_NAME}.exe" "dist/${BIN_NAME}-windows-aarch64.exe"

    # 3. Generate and sign INDIVIDUAL SHA256 checksum files for each binary
    - cd dist
    - for file in *; do
      if [ -f "$file" ]; then
      sha256sum "$file" > "${file}.sha256";
      echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --detach-sign --armor --local-user "$GPG_KEY_ID" "${file}";
      fi
      done
    - cd ..

    # 4. Authenticate glab using the CI job token
    - glab auth login --hostname $CI_SERVER_HOST --job-token $CI_JOB_TOKEN

    # 5. Generate release notes from template
    - |
      if [ ! -f "${RELEASE_NOTES_TEMPLATE}" ]; then
        echo "ERROR: Template file '${RELEASE_NOTES_TEMPLATE}' not found."
        exit 1
      fi
      export TEMPLATE_DATE=$(date -u +'%Y-%m-%d')
      export TEMPLATE_VERSION="$CI_COMMIT_TAG"
      export TEMPLATE_RUST_TOOLCHAIN="nightly-${RUST_NIGHTLY_DATE}"
      envsubst < "${RELEASE_NOTES_TEMPLATE}" > /tmp/release_notes_generated.md
      echo "Generated release notes:"
      cat /tmp/release_notes_generated.md

    # 6. Create the release using the generated notes and upload all assets
    - glab release create $CI_COMMIT_TAG --name "Release $CI_COMMIT_TAG" --notes-file /tmp/release_notes_generated.md
    - glab release upload $CI_COMMIT_TAG dist/*
